{"version":3,"file":"AsyncDisposeAggregator.js","sourceRoot":"","sources":["../src/AsyncDisposeAggregator.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,aAAa,EAAC,MAAM,oBAAoB,CAAC;AAEjD;;;;;;;;;;;;;;;;;;;;;;;;GAwBG;AACH,MAAM,OAAO,sBAAsB;IAC/B,gBAAgB,CAAkB,QAAQ,GAAmC,EAAE,CAAC;IAChF,gBAAgB,CAAS,SAAS,GAAY,KAAK,CAAC;IAEpD;QACI,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC/B,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACvC,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACrE,CAAC;IAED;;;OAGG;IACI,GAAG,CAAC,MAAoC;QAC3C,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAC1B,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAE3B,OAAO,IAAI,CAAC;IAChB,CAAC;IAED;;OAEG;IACI,KAAK,CAAC,OAAO;QAChB,IAAI,IAAI,CAAC,SAAS;YACd,OAAO;QAEX,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QAEtB,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC9B,IAAI,aAAa,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;YAE1C,IAAI,aAAa,YAAY,OAAO,EAAE,CAAC;gBACnC,IAAI,CAAC;oBACD,aAAa,GAAG,MAAM,aAAa,CAAC;gBACxC,CAAC;gBAAC,OAAO,GAAG,EAAE,CAAC;oBACX,qBAAqB;oBACrB,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;oBACnB,SAAS;gBACb,CAAC,CAAC,oBAAoB;YAC1B,CAAC;YAED,IAAI,OAAO,OAAO,KAAK,WAAW,IAAI,aAAa,YAAY,OAAO;gBAClE,aAAa,GAAG,aAAa,CAAC,KAAK,EAAE,CAAC;YAE1C,IAAI,aAAa,IAAI,IAAI;gBACrB,SAAS;iBACR,IACD,MAAM,CAAC,YAAY,IAAI,IAAI,IAAI,MAAM,CAAC,YAAY,IAAI,aAAa;gBACnE,aAAa,CAAC,MAAM,CAAC,YAAY,CAAC,YAAY,QAAQ;gBAEtD,MAAM,aAAa,CAAC,MAAM,CAAC,YAAY,CAAC,EAAE,CAAC;iBAC1C,IACD,MAAM,CAAC,OAAO,IAAI,IAAI,IAAI,MAAM,CAAC,OAAO,IAAI,aAAa;gBACzD,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,YAAY,QAAQ;gBAEjD,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC;iBAC/B,IAAI,SAAS,IAAI,aAAa,IAAI,aAAa,CAAC,OAAO,YAAY,QAAQ;gBAC5E,MAAM,aAAa,CAAC,OAAO,EAAE,CAAC;iBAC7B,IAAI,aAAa,YAAY,QAAQ;gBACtC,MAAM,aAAa,EAAE,CAAC;QAC9B,CAAC;IACL,CAAC;IAEM,KAAK,CAAC,CAAC,MAAM,CAAC,YAAY,CAAC;QAC9B,OAAO,IAAI,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IAED,IAAW,WAAW;QAClB,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC;IAChC,CAAC;IAED,gBAAgB;IACR,kBAAkB;QACtB,IAAI,IAAI,CAAC,SAAS;YACd,MAAM,IAAI,aAAa,EAAE,CAAC;IAClC,CAAC;CACJ","sourcesContent":["import {DisposedError} from \"./DisposedError.js\";\n\n/**\n * `AsyncDisposeAggregator` is a utility class that allows you to add multiple items and then dispose them all at once.\n * The items are disposed one by one in the order they were added.\n * You can add a function to call, an object with a `dispose` method, an object with a `Symbol.dispose` method,\n * an object with a `Symbol.asyncDispose` method, or a Promise that resolves to one of the previous types.\n * To dispose all the items, call `dispose` or use the `Symbol.asyncDispose` symbol.\n * The difference between `AsyncDisposeAggregator` and `DisposeAggregator` is that `AsyncDisposeAggregator` can dispose async targets.\n *\n * For example,\n * ```typescript\n * import {AsyncDisposeAggregator, EventRelay} from \"lifecycle-utils\";\n *\n * const disposeAggregator = new AsyncDisposeAggregator();\n *\n * const eventRelay = new EventRelay<string>();\n * disposeAggregator.add(eventRelay);\n *\n * disposeAggregator.add(async () => {\n *     await new Promise(resolve => setTimeout(resolve, 0));\n *     // do some async work\n * });\n *\n * disposeAggregator.dispose();\n * ```\n */\nexport class AsyncDisposeAggregator {\n    /** @internal */ private readonly _targets: AsyncDisposeAggregatorTarget[] = [];\n    /** @internal */ private _disposed: boolean = false;\n\n    public constructor() {\n        this.add = this.add.bind(this);\n        this.dispose = this.dispose.bind(this);\n        this[Symbol.asyncDispose] = this[Symbol.asyncDispose].bind(this);\n    }\n\n    /**\n     * Adds a target to be disposed.\n     * You can wrap the target with a `WeakRef` to prevent this class from holding a strong reference to the target.\n     */\n    public add(target: AsyncDisposeAggregatorTarget): this {\n        this._ensureNotDisposed();\n        this._targets.push(target);\n\n        return this;\n    }\n\n    /**\n     * Disposes all the targets that have been added and clears the list of targets.\n     */\n    public async dispose(): Promise<void> {\n        if (this._disposed)\n            return;\n\n        this._disposed = true;\n\n        while (this._targets.length > 0) {\n            let disposeTarget = this._targets.shift();\n\n            if (disposeTarget instanceof Promise) {\n                try {\n                    disposeTarget = await disposeTarget;\n                } catch (err) {\n                    /* c8 ignore start */\n                    console.error(err);\n                    continue;\n                } /* c8 ignore stop */\n            }\n\n            if (typeof WeakRef !== \"undefined\" && disposeTarget instanceof WeakRef)\n                disposeTarget = disposeTarget.deref();\n\n            if (disposeTarget == null)\n                continue;\n            else if (\n                Symbol.asyncDispose != null && Symbol.asyncDispose in disposeTarget &&\n                disposeTarget[Symbol.asyncDispose] instanceof Function\n            )\n                await disposeTarget[Symbol.asyncDispose]();\n            else if (\n                Symbol.dispose != null && Symbol.dispose in disposeTarget &&\n                disposeTarget[Symbol.dispose] instanceof Function\n            )\n                disposeTarget[Symbol.dispose]();\n            else if (\"dispose\" in disposeTarget && disposeTarget.dispose instanceof Function)\n                await disposeTarget.dispose();\n            else if (disposeTarget instanceof Function)\n                await disposeTarget();\n        }\n    }\n\n    public async [Symbol.asyncDispose](): Promise<void> {\n        return this.dispose();\n    }\n\n    public get targetCount(): number {\n        return this._targets.length;\n    }\n\n    /** @internal */\n    private _ensureNotDisposed(): void {\n        if (this._disposed)\n            throw new DisposedError();\n    }\n}\n\nexport type AsyncDisposeAggregatorTarget = AsyncDisposeAggregatorWrappedTarget | Promise<AsyncDisposeAggregatorWrappedTarget>;\n\nexport type AsyncDisposeAggregatorWrappedTarget = (() => void | Promise<void>) | {\n    [Symbol.asyncDispose](): void | Promise<void>\n} | {\n    [Symbol.dispose](): void\n} | {\n    dispose(): void | Promise<void>\n} | WeakRef<{\n    [Symbol.asyncDispose](): void | Promise<void>\n} | {\n    [Symbol.dispose](): void\n} | {\n    dispose(): void | Promise<void>\n}>;\n"]}
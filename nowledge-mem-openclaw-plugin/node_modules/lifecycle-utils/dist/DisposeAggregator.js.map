{"version":3,"file":"DisposeAggregator.js","sourceRoot":"","sources":["../src/DisposeAggregator.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,aAAa,EAAC,MAAM,oBAAoB,CAAC;AAEjD;;;;;;;;;;;;;;;;;;GAkBG;AACH,MAAM,OAAO,iBAAiB;IAC1B,gBAAgB,CAAkB,QAAQ,GAA8B,EAAE,CAAC;IAC3E,gBAAgB,CAAS,SAAS,GAAY,KAAK,CAAC;IAEpD;QACI,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC/B,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACvC,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC3D,CAAC;IAED;;;OAGG;IACI,GAAG,CAAoC,MAAS;QACnD,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAC1B,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAE3B,OAAO,MAAM,CAAC;IAClB,CAAC;IAED;;OAEG;IACI,OAAO;QACV,IAAI,IAAI,CAAC,SAAS;YACd,OAAO;QAEX,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC9B,IAAI,aAAa,GAAG,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;YAE1C,IAAI,OAAO,OAAO,KAAK,WAAW,IAAI,aAAa,YAAY,OAAO;gBAClE,aAAa,GAAG,aAAa,CAAC,KAAK,EAAE,CAAC;YAE1C,IAAI,aAAa,IAAI,IAAI;gBACrB,SAAS;iBACR,IAAI,MAAM,CAAC,OAAO,IAAI,IAAI,IAAI,MAAM,CAAC,OAAO,IAAI,aAAa,IAAI,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,YAAY,QAAQ;gBACnH,aAAa,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC;iBAC/B,IAAI,SAAS,IAAI,aAAa,IAAI,aAAa,CAAC,OAAO,YAAY,QAAQ;gBAC5E,aAAa,CAAC,OAAO,EAAE,CAAC;iBACvB,IAAI,aAAa,YAAY,QAAQ;gBACtC,aAAa,EAAE,CAAC;QACxB,CAAC;QAED,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;IAC1B,CAAC;IAEM,CAAC,MAAM,CAAC,OAAO,CAAC;QACnB,IAAI,CAAC,OAAO,EAAE,CAAC;IACnB,CAAC;IAED,IAAW,WAAW;QAClB,OAAO,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC;IAChC,CAAC;IAED,gBAAgB;IACR,kBAAkB;QACtB,IAAI,IAAI,CAAC,SAAS;YACd,MAAM,IAAI,aAAa,EAAE,CAAC;IAClC,CAAC;CACJ","sourcesContent":["import {DisposedError} from \"./DisposedError.js\";\n\n/**\n * `DisposeAggregator` is a utility class that allows you to add multiple items and then dispose them all at once.\n * You can add a function to call, an object with a `dispose` method, or an object with a `Symbol.dispose` method.\n * To dispose all the items, call `dispose` or use the `Symbol.dispose` symbol.\n *\n * For example,\n * ```typescript\n * const disposeAggregator = new DisposeAggregator();\n *\n * const eventRelay = new EventRelay<string>();\n * disposeAggregator.add(eventRelay);\n *\n * const eventRelay2 = disposeAggregator.add(new EventRelay<string>());\n *\n * disposeAggregator.dispose();\n * console.log(eventRelay.disposed === true); // true\n * console.log(eventRelay2.disposed === true); // true\n * ```\n */\nexport class DisposeAggregator {\n    /** @internal */ private readonly _targets: DisposeAggregatorTarget[] = [];\n    /** @internal */ private _disposed: boolean = false;\n\n    public constructor() {\n        this.add = this.add.bind(this);\n        this.dispose = this.dispose.bind(this);\n        this[Symbol.dispose] = this[Symbol.dispose].bind(this);\n    }\n\n    /**\n     * Adds a target to be disposed.\n     * You can wrap the target with a `WeakRef` to prevent this class from holding a strong reference to the target.\n     */\n    public add<T extends DisposeAggregatorTarget>(target: T): T {\n        this._ensureNotDisposed();\n        this._targets.push(target);\n\n        return target;\n    }\n\n    /**\n     * Disposes all the targets that have been added and clears the list of targets.\n     */\n    public dispose(): void {\n        if (this._disposed)\n            return;\n\n        while (this._targets.length > 0) {\n            let disposeTarget = this._targets.shift();\n\n            if (typeof WeakRef !== \"undefined\" && disposeTarget instanceof WeakRef)\n                disposeTarget = disposeTarget.deref();\n\n            if (disposeTarget == null)\n                continue;\n            else if (Symbol.dispose != null && Symbol.dispose in disposeTarget && disposeTarget[Symbol.dispose] instanceof Function)\n                disposeTarget[Symbol.dispose]();\n            else if (\"dispose\" in disposeTarget && disposeTarget.dispose instanceof Function)\n                disposeTarget.dispose();\n            else if (disposeTarget instanceof Function)\n                disposeTarget();\n        }\n\n        this._disposed = true;\n    }\n\n    public [Symbol.dispose](): void {\n        this.dispose();\n    }\n\n    public get targetCount(): number {\n        return this._targets.length;\n    }\n\n    /** @internal */\n    private _ensureNotDisposed(): void {\n        if (this._disposed)\n            throw new DisposedError();\n    }\n}\n\nexport type DisposeAggregatorTarget = (() => void) | {\n    [Symbol.dispose](): void\n} | {\n    dispose(): void\n} | WeakRef<{\n    [Symbol.dispose](): void\n} | {\n    dispose(): void\n}>;\n"]}